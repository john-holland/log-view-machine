{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://log-view-machine.github.io/spec/cave-tome-security.schema.json",
  "title": "Cave, Tome, and Security configuration spec",
  "description": "Machine-readable spec for Cave/Spelunk structure, TomeConfig (routing, machines, bindings), and optional security. Shared across JS, Kotlin, and Java.",
  "definitions": {
    "Spelunk": {
      "type": "object",
      "description": "Cave descent: nested caves and tomes",
      "properties": {
        "childCaves": { "$ref": "#/definitions/SpelunkMap" },
        "tomes": { "type": "object" },
        "route": { "type": "string" },
        "container": { "type": "string" },
        "renderKey": { "type": "string" },
        "tomeId": { "type": "string" },
        "docker": {
          "type": "object",
          "properties": {
            "image": { "type": "string" },
            "composePath": { "type": "string" }
          }
        },
        "subdomains": { "type": "object" }
      },
      "additionalProperties": true
    },
    "SpelunkMap": {
      "type": "object",
      "additionalProperties": { "$ref": "#/definitions/Spelunk" }
    },
    "CaveConfig": {
      "type": "object",
      "properties": {
        "name": { "type": "string" },
        "spelunk": { "$ref": "#/definitions/Spelunk" },
        "wanOsRomRegistry": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "registryPath": { "type": "string" }
          }
        }
      },
      "required": ["name", "spelunk"]
    },
    "TomeBinding": {
      "type": "object",
      "properties": {
        "path": { "type": "string" },
        "method": { "enum": ["GET", "POST", "PUT", "DELETE", "PATCH"] },
        "middleware": { "type": "array", "items": { "type": "string" } },
        "guards": { "type": "array", "items": { "type": "string" } }
      },
      "required": ["path"]
    },
    "TomeMachineConfig": {
      "type": "object",
      "properties": {
        "id": { "type": "string" },
        "name": { "type": "string" },
        "description": { "type": "string" },
        "xstateConfig": {},
        "context": { "type": "object" },
        "dependencies": { "type": "array", "items": { "type": "string" } },
        "location": { "enum": ["local", "remote", "same-cave"], "type": "string" },
        "remoteClient": { "type": "string" }
      },
      "required": ["id", "name", "xstateConfig"]
    },
    "TomeRouteConfig": {
      "type": "object",
      "properties": {
        "basePath": { "type": "string" },
        "middleware": { "type": "array", "items": { "type": "string" } },
        "cors": { "type": "boolean" },
        "rateLimit": {
          "type": "object",
          "properties": {
            "windowMs": { "type": "number" },
            "max": { "type": "number" }
          }
        },
        "authentication": {
          "type": "object",
          "properties": {
            "required": { "type": "boolean" },
            "type": { "enum": ["jwt", "api-key", "session"] }
          }
        }
      }
    },
    "TomeConfig": {
      "type": "object",
      "properties": {
        "id": { "type": "string" },
        "name": { "type": "string" },
        "description": { "type": "string" },
        "version": { "type": "string" },
        "renderKey": { "type": "string" },
        "machines": {
          "type": "object",
          "additionalProperties": { "$ref": "#/definitions/TomeMachineConfig" }
        },
        "routing": { "$ref": "#/definitions/TomeRouteConfig" },
        "context": { "type": "object" },
        "dependencies": { "type": "array", "items": { "type": "string" } },
        "plugins": { "type": "array", "items": { "type": "string" } }
      },
      "required": ["id", "name", "machines"]
    },
    "SecurityConfig": {
      "type": "object",
      "description": "Optional security section for Cave or adapter (TLS, auth, network labels)",
      "properties": {
        "transport": {
          "type": "object",
          "properties": {
            "tls": { "type": "boolean" },
            "mtls": { "type": "boolean" },
            "certPath": { "type": "string" },
            "keyPath": { "type": "string" },
            "trustStore": { "type": "string" }
          }
        },
        "authentication": {
          "type": "object",
          "properties": {
            "type": { "enum": ["jwt", "api-key", "session"] },
            "required": { "type": "boolean" },
            "issuer": { "type": "string" },
            "audience": { "type": "string" }
          }
        },
        "authorization": {
          "type": "object",
          "description": "Optional role/permission mapping for routes or Tomes",
          "additionalProperties": { "type": "array", "items": { "type": "string" } }
        },
        "network": {
          "type": "object",
          "properties": {
            "labels": {
              "type": "array",
              "items": { "type": "string" },
              "description": "e.g. internal, dmz - do not expose to public"
            }
          }
        },
        "messageToken": {
          "type": "object",
          "description": "CSRF-style token for cross-boundary Cave/Tome/VSM messages",
          "properties": {
            "secretEnv": { "type": "string" },
            "header": { "type": "string" },
            "ttlMs": { "type": "number" }
          }
        },
        "dataTransfer": {
          "type": "object",
          "description": "CORS and HTTP/2 settings",
          "properties": {
            "cors": {
              "type": "object",
              "properties": {
                "origin": {},
                "credentials": { "type": "boolean" },
                "methods": { "type": "array", "items": { "type": "string" } },
                "allowedHeaders": { "type": "array", "items": { "type": "string" } },
                "maxAge": { "type": "number" }
              }
            },
            "http2": {
              "oneOf": [
                { "type": "boolean" },
                { "type": "object", "properties": { "allowHTTP1": { "type": "boolean" } } }
              ]
            }
          }
        },
        "throttle": {
          "type": "object",
          "properties": {
            "maxRequestsPerMinute": { "type": "number" },
            "maxBytesPerMinute": { "type": "number" },
            "windowMs": { "type": "number" }
          }
        },
        "retryPolicy": {
          "type": "object",
          "properties": {
            "initialDelayMs": { "type": "number" },
            "maxDelayMs": { "type": "number" },
            "multiplier": { "type": "number" },
            "maxRetries": { "type": "number" },
            "jitter": { "type": "boolean" }
          }
        },
        "circuitBreaker": {
          "type": "object",
          "properties": {
            "threshold": { "type": "number" },
            "resetMs": { "type": "number" },
            "name": { "type": "string" }
          }
        },
        "sanitize": {
          "type": "object",
          "description": "Script-injection prevention: use core escapeText, unescapeText, parseHtml for user/cross-boundary content",
          "properties": {}
        }
      }
    }
  },
  "type": "object",
  "properties": {
    "cave": { "$ref": "#/definitions/CaveConfig" },
    "tome": { "$ref": "#/definitions/TomeConfig" },
    "security": { "$ref": "#/definitions/SecurityConfig" }
  }
}
