# Fluentd Configuration for Log Aggregation and Warehousing
# This configuration collects logs from multiple sources and routes them appropriately

<source>
  @type tail
  path /logs/*.log
  pos_file /logs/fluentd.pos
  tag fish-burger.logs
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%d %H:%M:%S.%L
  </parse>
</source>

<source>
  @type tail
  path /warehouse/*.log
  pos_file /warehouse/fluentd.pos
  tag fish-burger.warehouse
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%d %H:%M:%S.%L
  </parse>
</source>

# Filter for error logs
<filter fish-burger.logs>
  @type grep
  <regexp>
    key level
    pattern error
  </regexp>
</filter>

# Route logs based on service
<match fish-burger.logs>
  @type rewrite_tag_filter
  <rule>
    key service
    pattern /generic-editor/
    tag generic-editor.logs
  </rule>
  <rule>
    key service
    pattern /fish-burger/
    tag fish-burger.logs
  </rule>
  <rule>
    key service
    pattern /tome-server/
    tag tome-server.logs
  </rule>
</match>

# Output to warehouse for long-term storage
<match **.logs>
  @type file
  path /warehouse/aggregated
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type file
    path /warehouse/buffer
    flush_interval 10s
    chunk_limit_size 10m
    total_limit_size 1g
  </buffer>
</match>

# Output to console for debugging
<match **.logs>
  @type stdout
</match>

# Error handling
<label @ERROR>
  <match **>
    @type file
    path /logs/fluentd-error
    append true
  </match>
</label> 