<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium Editor - Wave Reader</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%2280%22 font-size=%2280%22>üé®</text></svg>">
    
    <!-- Monaco Editor -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/editor/editor.main.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        /* Header */
        .editor-header {
            background: #1e293b;
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #0f172a;
        }

        .editor-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .editor-title h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .dirty-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
            display: none;
        }

        .dirty-indicator.active {
            display: block;
        }

        .editor-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: #64748b;
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-success:hover {
            background: #047857;
        }

        /* Main Container */
        .editor-container {
            display: grid;
            grid-template-columns: 250px 1fr 400px;
            height: calc(100vh - 48px);
            background: #f8fafc;
        }

        /* Left Panel - File Tree */
        .file-panel {
            background: #f1f5f9;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 12px 16px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            color: #1e293b;
            font-size: 14px;
        }

        .file-tree {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .file-item {
            padding: 8px 12px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
            color: #475569;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-item:hover {
            background: #e2e8f0;
        }

        .file-item.active {
            background: #dbeafe;
            color: #1e40af;
            font-weight: 500;
        }

        .file-icon {
            font-size: 16px;
        }

        /* Center Panel - Code Editor */
        .editor-panel {
            display: flex;
            flex-direction: column;
            background: white;
        }

        .editor-tabs {
            display: flex;
            gap: 2px;
            padding: 8px 8px 0 8px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .editor-tab {
            padding: 8px 16px;
            background: #e2e8f0;
            border: none;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-size: 13px;
            color: #64748b;
            transition: all 0.2s;
        }

        .editor-tab.active {
            background: white;
            color: #1e293b;
            font-weight: 500;
        }

        .editor-tab:hover:not(.active) {
            background: #cbd5e1;
        }

        #monaco-editor {
            flex: 1;
            height: 100%;
        }

        /* Right Panel - Preview */
        .preview-panel {
            background: white;
            border-left: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
        }

        .preview-toolbar {
            padding: 8px 12px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .device-toggle {
            display: flex;
            gap: 4px;
        }

        .device-btn {
            padding: 6px 12px;
            border: 1px solid #cbd5e1;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .device-btn.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .preview-iframe-container {
            flex: 1;
            padding: 12px;
            overflow: auto;
        }

        .preview-iframe {
            width: 100%;
            height: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
        }

        .preview-iframe.mobile {
            width: 375px;
            margin: 0 auto;
        }

        .preview-iframe.tablet {
            width: 768px;
            margin: 0 auto;
        }

        .console-output {
            height: 150px;
            background: #1e293b;
            color: #e2e8f0;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 12px;
            padding: 12px;
            overflow-y: auto;
            border-top: 1px solid #0f172a;
        }

        .console-line {
            padding: 2px 0;
            line-height: 1.4;
        }

        .console-error {
            color: #fca5a5;
        }

        .console-warn {
            color: #fde047;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .editor-container {
                grid-template-columns: 200px 1fr 350px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="editor-header">
        <div class="editor-title">
            <span>üé®</span>
            <h1 id="componentName">Premium Editor</h1>
            <div class="dirty-indicator" id="dirtyIndicator"></div>
        </div>
        <div class="editor-actions">
            <button class="btn btn-secondary" id="undoBtn" title="Undo (Cmd+Z)">
                ‚Ü∂ Undo
            </button>
            <button class="btn btn-secondary" id="redoBtn" title="Redo (Cmd+Shift+Z)">
                ‚Ü∑ Redo
            </button>
            <button class="btn btn-success" id="saveBtn" title="Save (Cmd+S)">
                üíæ Save
            </button>
            <button class="btn btn-secondary" id="closeBtn">
                ‚úï Close
            </button>
        </div>
    </div>

    <!-- Main Editor Container -->
    <div class="editor-container">
        <!-- Left Panel: File Tree -->
        <div class="file-panel">
            <div class="panel-header">
                üìÅ Files
            </div>
            <div class="file-tree" id="fileTree">
                <!-- Files will be populated here -->
            </div>
        </div>

        <!-- Center Panel: Code Editor -->
        <div class="editor-panel">
            <div class="editor-tabs" id="editorTabs">
                <!-- Tabs will be populated here -->
            </div>
            <div id="monaco-editor"></div>
        </div>

        <!-- Right Panel: Preview -->
        <div class="preview-panel">
            <div class="panel-header">
                üëÅÔ∏è Live Preview
            </div>
            <div class="preview-toolbar">
                <div class="device-toggle">
                    <button class="device-btn active" data-device="desktop">
                        üñ•Ô∏è Desktop
                    </button>
                    <button class="device-btn" data-device="tablet">
                        üì± Tablet
                    </button>
                    <button class="device-btn" data-device="mobile">
                        üì± Mobile
                    </button>
                </div>
                <button class="btn btn-secondary btn-sm" id="refreshPreview" style="margin-left: auto; font-size: 12px; padding: 4px 12px;">
                    üîÑ Refresh
                </button>
            </div>
            <div class="preview-iframe-container">
                <iframe id="previewIframe" class="preview-iframe" sandbox="allow-scripts allow-same-origin"></iframe>
            </div>
            <div class="console-output" id="consoleOutput">
                <div class="console-line">Console output will appear here...</div>
            </div>
        </div>
    </div>

    <!-- Monaco Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    
    <script>
        // Global state
        let editor = null;
        let currentComponent = null;
        let currentFile = null;
        let isDirty = false;
        let fileContents = {};
        let undoStack = [];
        let redoStack = [];

        // Initialize Monaco Editor
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
        
        require(['vs/editor/editor.main'], function() {
            editor = monaco.editor.create(document.getElementById('monaco-editor'), {
                value: '// Select a file to begin editing',
                language: 'typescript',
                theme: 'vs-dark',
                automaticLayout: true,
                minimap: { enabled: true },
                fontSize: 14,
                lineNumbers: 'on',
                rulers: [80, 120],
                formatOnPaste: true,
                formatOnType: true
            });

            // Listen for content changes
            editor.onDidChangeModelContent(() => {
                if (currentFile) {
                    markDirty();
                    fileContents[currentFile] = editor.getValue();
                    updatePreview();
                }
            });

            // Load component from URL
            const urlParams = new URLSearchParams(window.location.search);
            const componentId = urlParams.get('component');
            if (componentId) {
                loadComponent(componentId);
            }
        });

        // Load component data
        async function loadComponent(componentId) {
            console.log('üìÇ Loading component:', componentId);
            
            // TODO: Fetch from API
            // For now, use mock data
            const mockComponents = {
                'wave-tabs': {
                    name: 'Wave Tabs',
                    files: {
                        'component.tsx': '// Wave Tabs Component\nimport React from "react";\n\nexport const WaveTabs = () => {\n  return <div>Wave Tabs</div>;\n};',
                        'styles.css': '.wave-tabs { padding: 1rem; }',
                        'types.ts': 'export interface Tab { id: string; label: string; }'
                    }
                }
            };

            currentComponent = mockComponents[componentId] || {
                name: componentId,
                files: {}
            };

            document.getElementById('componentName').textContent = `Premium Editor - ${currentComponent.name}`;
            
            // Load files
            fileContents = { ...currentComponent.files };
            renderFileTree();
            
            // Load first file
            const firstFile = Object.keys(fileContents)[0];
            if (firstFile) {
                loadFile(firstFile);
            }
        }

        // Render file tree
        function renderFileTree() {
            const fileTree = document.getElementById('fileTree');
            fileTree.innerHTML = '';

            Object.keys(fileContents).forEach(filename => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `<span class="file-icon">${getFileIcon(filename)}</span><span>${filename}</span>`;
                fileItem.onclick = () => loadFile(filename);
                fileTree.appendChild(fileItem);
            });
        }

        // Get file icon
        function getFileIcon(filename) {
            if (filename.endsWith('.tsx') || filename.endsWith('.ts')) return 'üìò';
            if (filename.endsWith('.jsx') || filename.endsWith('.js')) return 'üìÑ';
            if (filename.endsWith('.css')) return 'üé®';
            if (filename.endsWith('.html')) return 'üåê';
            if (filename.endsWith('.json')) return 'üìã';
            return 'üìÑ';
        }

        // Load file into editor
        function loadFile(filename) {
            currentFile = filename;
            const content = fileContents[filename] || '';
            
            // Update editor content
            if (editor) {
                editor.setValue(content);
                
                // Set language based on file extension
                const language = getLanguageFromFilename(filename);
                monaco.editor.setModelLanguage(editor.getModel(), language);
            }

            // Update UI
            document.querySelectorAll('.file-item').forEach((item, index) => {
                item.classList.remove('active');
                if (Object.keys(fileContents)[index] === filename) {
                    item.classList.add('active');
                }
            });

            updateTabs();
        }

        // Get Monaco language from filename
        function getLanguageFromFilename(filename) {
            if (filename.endsWith('.tsx')) return 'typescript';
            if (filename.endsWith('.ts')) return 'typescript';
            if (filename.endsWith('.jsx')) return 'javascript';
            if (filename.endsWith('.js')) return 'javascript';
            if (filename.endsWith('.css')) return 'css';
            if (filename.endsWith('.html')) return 'html';
            if (filename.endsWith('.json')) return 'json';
            return 'plaintext';
        }

        // Update tabs
        function updateTabs() {
            const tabsContainer = document.getElementById('editorTabs');
            tabsContainer.innerHTML = '';

            Object.keys(fileContents).forEach(filename => {
                const tab = document.createElement('button');
                tab.className = 'editor-tab' + (filename === currentFile ? ' active' : '');
                tab.textContent = filename;
                tab.onclick = () => loadFile(filename);
                tabsContainer.appendChild(tab);
            });
        }

        // Mark editor as dirty
        function markDirty() {
            isDirty = true;
            document.getElementById('dirtyIndicator').classList.add('active');
        }

        // Clear dirty state
        function clearDirty() {
            isDirty = false;
            document.getElementById('dirtyIndicator').classList.remove('active');
        }

        // Update preview
        function updatePreview() {
            const iframe = document.getElementById('previewIframe');
            const doc = iframe.contentDocument || iframe.contentWindow.document;

            // Build preview HTML
            const htmlFiles = Object.entries(fileContents)
                .filter(([name]) => name.endsWith('.html'))
                .map(([_, content]) => content)
                .join('\n');

            const cssFiles = Object.entries(fileContents)
                .filter(([name]) => name.endsWith('.css'))
                .map(([_, content]) => content)
                .join('\n');

            const jsFiles = Object.entries(fileContents)
                .filter(([name]) => name.endsWith('.js'))
                .map(([_, content]) => content)
                .join('\n');

            const previewHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <style>${cssFiles}</style>
                </head>
                <body>
                    ${htmlFiles}
                    <script>${jsFiles}<\/script>
                </body>
                </html>
            `;

            doc.open();
            doc.write(previewHtml);
            doc.close();
        }

        // Save component
        async function saveComponent() {
            console.log('üíæ Saving component...');
            
            // TODO: API call to save
            // await fetch(`/api/editor/save/${currentComponent.id}`, {
            //     method: 'POST',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify({ files: fileContents })
            // });

            clearDirty();
            logConsole('‚úÖ Component saved successfully');
        }

        // Undo/Redo (simple implementation)
        function undo() {
            console.log('‚Ü∂ Undo');
            // TODO: Integrate with EditorMachine undo service
            editor.trigger('keyboard', 'undo', null);
        }

        function redo() {
            console.log('‚Ü∑ Redo');
            // TODO: Integrate with EditorMachine redo service
            editor.trigger('keyboard', 'redo', null);
        }

        // Console logging
        function logConsole(message, type = 'log') {
            const consoleOutput = document.getElementById('consoleOutput');
            const line = document.createElement('div');
            line.className = 'console-line' + (type === 'error' ? ' console-error' : type === 'warn' ? ' console-warn' : '');
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            consoleOutput.appendChild(line);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        // Device preview toggle
        document.querySelectorAll('.device-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.device-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                const device = this.dataset.device;
                const iframe = document.getElementById('previewIframe');
                iframe.className = 'preview-iframe' + (device === 'desktop' ? '' : ` ${device}`);
            });
        });

        // Button event listeners
        document.getElementById('saveBtn').addEventListener('click', saveComponent);
        document.getElementById('undoBtn').addEventListener('click', undo);
        document.getElementById('redoBtn').addEventListener('click', redo);
        document.getElementById('refreshPreview').addEventListener('click', updatePreview);
        
        document.getElementById('closeBtn').addEventListener('click', () => {
            if (isDirty) {
                if (confirm('You have unsaved changes. Are you sure you want to close?')) {
                    window.close();
                }
            } else {
                window.close();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === 's') {
                e.preventDefault();
                saveComponent();
            }
            if ((e.metaKey || e.ctrlKey) && e.key === 'z') {
                e.preventDefault();
                if (e.shiftKey) {
                    redo();
                } else {
                    undo();
                }
            }
        });

        // Log initialization
        logConsole('üé® Premium Editor initialized');
    </script>
</body>
</html>

